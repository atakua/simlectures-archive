% Compile with XeLaTeX, TeXLive 2013 or more recent
\documentclass{beamer}

% Base packages
\usepackage{fontspec}
\usepackage{xunicode}
\usepackage{xltxtra}

\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{longtable}
\usepackage{csquotes}
\usepackage{standalone}

% Setup fonts
\newfontfamily\russianfont{CMU Serif}
\setromanfont{CMU Serif}
\setsansfont{CMU Sans Serif}
\setmonofont{CMU Typewriter Text}

% Setup Russian hyphenation. NOTE: this declaration *must* come after fontspec's font declarations,
% or a mysterious (but harmless in other respects) error "Improper `at' size (0.0pt), replaced by 10pt." would appear.
\usepackage{polyglossia}
\defaultfontfeatures{Scale=MatchLowercase, Mapping=tex-text}

\setdefaultlanguage[spelling=modern]{russian} % for polyglossia
\setotherlanguage{english} % for polyglossia

% Vector drawings
\usepackage{tikz}
% \usetikzlibrary{shapes, calc, arrows, fit, positioning, decorations, patterns, decorations.pathreplacing, chains, snakes}
\usetikzlibrary{shapes, calc, arrows, decorations.markings, decorations.pathmorphing, decorations, patterns, chains, snakes, backgrounds, positioning, fit, petri}
\usepackage[siunitx]{circuitikz}

% Be able to insert hyperlinks
\usepackage{hyperref}
\hypersetup{colorlinks=true, linkcolor=black, filecolor=black, citecolor=black, urlcolor=blue , pdfauthor=Grigory Rechistov <grigory.rechistov@phystech.edu>, pdftitle=Курс «Программное моделирование вычислительных систем»}
% \usepackage{url}

% Misc optional packages
\usepackage{underscore}
\usepackage{amsthm}

% A new command to mark not done places
\newcommand{\todo}[1][Напиши меня]{{\color{red}TODO\ #1}}
\newcommand{\abbr}{\textit{англ.}\ }

\title{Моделирование центрального процессора с помощью интерпретации}
\subtitle{Курс «Программное моделирование вычислительных систем»}
\subject{Курс «Программное моделирование вычислительных систем»}

\author[]{Григорий Речистов \\ \small{\href{mailto:grigory.rechistov@phystech.edu}{grigory.rechistov@phystech.edu}}}
\date{\today}
\pgfdeclareimage[height=0.5cm]{ilab-logo}{../ilab-noletters.png}
\logo{\pgfuseimage{ilab-logo}}

\typeout{Copyright 2015 Grigory Rechistov}

\usetheme{Berlin}
\setbeamertemplate{navigation symbols}{}%remove navigation symbols

\begin{document}

\begin{frame}
    \maketitle
\end{frame}

\section*{Обзор}

\begin{frame}{На прошлой лекции}
\end{frame}


\begin{frame}{На этой лекции}
\tableofcontents
\end{frame} 

% Use [fragile] option to insert listings
% \begin{frame}[fragile]

\section{Цикл работы процессора}

\begin{frame}{Цикл работы процессора}
\centering
\include{./../../simbook/metoda/drawings/interp-cycle-expanded}
\end{frame}

\begin{frame}[fragile]{Переключаемый интерпретатор (switched)}
\begin{verbatim}
while (run) {
    raw_code = fetch(PC);
    (opcode, operands) = decode(raw_code);
    switch (opcode) {

    case opcode1:
        func1(operands); PC++; break;

    case opcode2:
        func2(operands); PC++; break;

    /*...*/
    }
}
\end{verbatim}
\end{frame}


\begin{frame}{Уточненный цикл работы}
\centering

\include{./../../simbook/metoda/drawings/interp-cycle-expanded-exception}

\end{frame}


\section{Fetch}

\begin{frame}{Чтение инструкции из памяти}

<<Простое>> чтение байт из памяти?

\pause

\begin{itemize}
    \item Невыровненный (\abbr unaligned) адрес в памяти. \\
    Вызывает эффекты в некоторых архитектурах.
    \pause\bigskip
    \item Доступ на границе двух страниц памяти. \\
    Разные страницы могут иметь разные характеристики.
\end{itemize}

\end{frame}

\begin{frame}{Порядок байт при доступах}

\begin{itemize}
    \item Порядок от младшего к старшему (\abbr little-endian);
    \item Порядок от старшего к младшему (\abbr big-endian);
    \item Смешанный порядок (\abbr middle-endian).
\end{itemize}

\pause

\begin{table}[htpb]
    \centering
    \begin{tabular}{|l|l|}
    \hline
    Представление   &   D4 + C3 * 100 + B2 * 10000 + A1 * 1000000   \\
    \hline
    Little-endian   &   D4, C3, B2, A1                              \\
    \hline
    Big-endian      &   A1, B2, C3, D4                              \\
    \hline
    \end{tabular}
\end{table}

\end{frame}

\begin{frame}{Бит, байт, слово}

Бит \pause — наименьшая единица информации.

\pause\bigskip

Байт \pause — минимальная адресуемая (в данной архитектуре) единица хранения
информации.

\pause\bigskip

Октет — восемь бит.

\pause\bigskip

Машинное слово \pause — максимальный объём информации, который ЦПУ может
обработать единовременно.

\pause\bigskip

Intel: word — 16 бит, dword — 32 бит, qword — 64 бит.

\end{frame}

\section{Decode}

\begin{frame}{Анатомия инструкции}
\centering
\include{instruction-anatomy}
\end{frame}

\begin{frame}{Декодирование}
Задача декодирования — перевод данных об инструкции из машинного представление
во внутреннее (высокоуровневое) удобное для последующего анализа.

\pause

Вход: \texttt{\textcolor{red}{0x40} \textcolor{green}{0x05} \textcolor{blue}{0xab 0x12}}

Результат:

\texttt{instruction \{ \\
~~~~opcode = \textcolor{red}{ADDI}, num\_operands = 2, \\
~~~~\textcolor{green}{dst = \{type = OP\_REG, reg = R5\}}, \\
~~~~\textcolor{blue}{src = \{type = OP\_IMM, val = 0x12ab\}}, \\
~~~~disasm = "addi r5, 0x12ab", \\
~~~~addr = 0x1234 \\
\}}
\end{frame}

\begin{frame}{Декодирование}
Код декодера редко пишется вручную, он генерируется по описанию:

\texttt{\textcolor{red}{A5} \textcolor{blue}{Y}\textcolor{green}{X} 0\textcolor{orange}{Z} 00} $\Rightarrow$ \textcolor{red}{MOD} \textcolor{green}{RX}, \textcolor{blue}{RY}, \textcolor{orange}{RZ}

\pause\bigskip

В общем случае классическаяя задача построения  синтаксического анализатора.

\pause\bigskip

Пример декодера — XED (x86 encoder-decoder) \url{https://software.intel.com/sites/landingpage/pintool/docs/61206/Xed/html/}.
\end{frame}

\begin{frame}{Дизассемблирование}
Дизассемблирование — перевод инструкций из машинного представление понятный
человеку вид (мнемонику).

\pause\bigskip

Закодирование (encoding) — перевод инструкций из мнемонической записи в
машинный код.
\end{frame}

\section{Execute}

\begin{frame}{Исполнение}

Базовая единица — функция-эмулятор одной инструкции (service routine).

\bigskip

s.r. пишутся на языке высокого уровня — переносимость кода между хозяйскими
платформами, компиляторами.

\bigskip

Используются генераторы кода.

Пример: SimGen — из одного описания генерируются декодер, дизассемблер и s.r.

\end{frame}

\section{Write Back}

\begin{frame}{Запись результата в память}

<<Обычная>> запись в память:

\pause

\begin{itemize}
    \item Невыровненные адрес,
    \item Граница страниц,
    \item Попытка изменить регион памяти доступный только для чтения,
    \item Часть результата может быть записана, а потом случится исключение.
\end{itemize}

\end{frame}

\section{Advance \texttt{PC}}

\begin{frame}{Продвижение \texttt{\$PC}}

\begin{itemize}
    \item Для большинства команд увеличение счетчика на длину обработанной инструкции. \\
    Ислючение: \texttt{REP MOVS}.
    \pause\bigskip
    \item Явное изменение \texttt{\$PC} — команды управления исполнением:
    \begin{itemize}
        \item (Un)conditional (In)direct Jump/Branch,
        \item Call/Return (subroutine).
    \end{itemize}
\end{itemize}

\end{frame}


\section{Практика}

\begin{frame}{Структура кода}

Файл \texttt{modules/chip16/chip16.h}

\texttt{struct chip16\_t;} — состояние процессора.

\pause\bigskip

Файл \texttt{modules/chip16/chip16.c}

Функции:

\begin{itemize}
    \item chip16\_string\_decode — дизассемблер,
    \item chip16\_execute — декодирование и исполнение,
    \item cr\_register\_attributes — регистрация атрибутов.
\end{itemize}

\end{frame}

\begin{frame}[fragile]{Тестирование}

\texttt{test/chip16/unit-tests/nop/s-nop.py}

\begin{verbatim}[language=python, basicstyle=\scriptsize]
# This test checks NOP instruction
import stest

cli.run_command("run-python-file %s/targets/chip16/machine.py" % conf.sim.workspace)

def test_nop_availability(cpu):
    paddr = 0
    cpu.pc = paddr
    # NOP
    simics.SIM_write_phys_memory(cpu, paddr, 0, 4)
    SIM_continue(1)
    stest.expect_equal(cpu.pc, paddr + 4)
    print "NOP: success"

test_nop_availability(conf.chip0)
\end{verbatim}

Запуск: \texttt{> bin/test-runner test/chip16/unit-tests/nop}
\end{frame}

\begin{frame}{Инструкции для реализации}
\begin{enumerate}
    \item MULI RX, HHLL;
    \item XOR RX, RY;
    \item ADD RX, RY;
    \item SUB RX, RY;
    \item CMPI RX, HHLL;
    \item AND RX, RY, RZ.
\end{enumerate}
\end{frame}


\section*{Конец}
% The final "thank you" frame 


\begin{frame}{На следующей лекции}
\end{frame}


\begin{frame}

{\huge{Спасибо за внимание!}\par}

\vfill

\tiny{\textit{Замечание}: все торговые марки и логотипы, использованные в данном материале, являются собственностью их владельцев. Представленная здесь точка зрения отражает личное мнение автора, не выступающего от лица какой-либо организации.}

\end{frame}

\end{document}
